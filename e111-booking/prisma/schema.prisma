generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// 1. 分館資料表 (Branches)
model Branch {
  id        Int      @id @default(autoincrement())
  name      String   // @db.VarChar(50) -> String
  code      String?  @unique // @db.VarChar(10) -> String
  address   String?  // @db.VarChar(200) -> String
  phone     String?  // @db.VarChar(20) -> String
  lineUrl   String?  // @db.VarChar(255) -> String (LINE官方帳號連結)
  isActive  Boolean  @default(true) // 是否營業中
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customers Customer[]
  staff     Staff[]
  bookings  Booking[] // 該分館的所有預約
}

// 2. 服務分類資料表 (ServiceCategories)
model ServiceCategory {
  id        Int      @id @default(autoincrement())
  name      String   // @db.VarChar(50) -> String (ex: 全身按摩, 腳底按摩)
  description String?  // @db.Text -> String
  sortOrder Int      @default(0) // 排序權重
  isActive  Boolean  @default(true)
  
  services  Service[]
}

// 3. 服務項目資料表 (Services)
model Service {
  id             Int      @id @default(autoincrement())
  categoryId     Int
  name           String   // @db.VarChar(100) -> String (ex: 全身經絡指壓)
  durationMinutes Int     // 服務時長 (分鐘)
  basePrice      Decimal  // 基礎價格 (SQLite stores Decimal as Float/String internally but Prisma handles it)
  description    String?  // @db.Text -> String
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  category       ServiceCategory @relation(fields: [categoryId], references: [id])
  bookingItems   BookingItem[]
}

// 4. 技師資料表 (Staff)
model Staff {
  id        Int      @id @default(autoincrement())
  branchId  Int
  name      String   // @db.VarChar(50) -> String
  code      String?  // @db.VarChar(10) -> String (技師編號 ex: 88, 99)
  level     String   // Enum 'StaffLevel' -> String (Master, Senior, Junior)
  // SQLite doesn't support Enums natively
  
  photoUrl  String?  // @db.VarChar(255) -> String (技師照片)
  bio       String?  // @db.Text -> String (簡介)
  isActive  Boolean  @default(true) // 是否在職/可預約
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch        Branch @relation(fields: [branchId], references: [id])
  availability  StaffAvailability[]
  bookings      Booking[] // 該技師被指定的預約 (主技師)
  bookingItems  BookingItem[] // 該技師實際執行的項目
}

// 5. 技師班表/可用時段 (StaffAvailability)
model StaffAvailability {
  id        Int      @id @default(autoincrement())
  staffId   Int
  date      DateTime // @db.Date -> DateTime (SQLite stores as String/Numeric)
  startTime DateTime // @db.Time -> DateTime (SQLite stores as String/Numeric)
  endTime   DateTime // @db.Time -> DateTime
  isBooked  Boolean  @default(false) // 是否已被預約 (簡單版標記)
  
  // NOTE: 更複雜的排班可能需要另一個 Table 存每週規律班表

  staff     Staff @relation(fields: [staffId], references: [id])

  @@index([staffId, date])
}

// 6. 客戶資料表 (Customers)
model Customer {
  id        Int      @id @default(autoincrement())
  phone     String   @unique // @db.VarChar(20) -> String (主要識別欄位)
  name      String?  // @db.VarChar(50) -> String
  email     String?  // @db.VarChar(100) -> String
  lineId    String?  // @db.VarChar(50) -> String
  preferredBranchId Int?
  notes     String?  // @db.Text -> String (備註: 喜好、黑名單原因等)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch    Branch? @relation(fields: [preferredBranchId], references: [id])
  bookings  Booking[]
}

// 7. 預約主表 (Bookings)
model Booking {
  id        Int      @id @default(autoincrement())
  branchId  Int
  customerId Int
  staffId   Int?     // 指定技師 (若不指定則為 null, 或排班決定)
  
  bookingDate DateTime // @db.Date -> DateTime (預約日期)
  startTime   DateTime // @db.Time -> DateTime (預約開始時間)
  endTime     DateTime // @db.Time -> DateTime (預計結束時間)
  
  totalPrice  Decimal
  status      String   // Enum 'BookingStatus' -> String (Pending, Confirmed, Completed, Cancelled, NoShow)
  
  customerNotes String? // @db.Text -> String (客戶留言)
  internalNotes String? // @db.Text -> String (內部備註)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  branch      Branch   @relation(fields: [branchId], references: [id])
  customer    Customer @relation(fields: [customerId], references: [id])
  staff       Staff?   @relation(fields: [staffId], references: [id])
  items       BookingItem[]
}

// 8. 預約細項 (BookingItems) - 用於一張單包含多個服務 (ex: 腳底 + 全身)
model BookingItem {
  id        Int      @id @default(autoincrement())
  bookingId Int
  serviceId Int
  staffId   Int?     // 該項目實際執行的技師 (可能不同項目不同人)
  price     Decimal  // 該項目的實際成交價
  
  booking   Booking @relation(fields: [bookingId], references: [id])
  service   Service @relation(fields: [serviceId], references: [id])
  staff     Staff?  @relation(fields: [staffId], references: [id])
}
