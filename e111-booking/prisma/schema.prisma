generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// 分館 (Branch)
model Branch {
  id        Int      @id @default(autoincrement())
  name      String
  code      String?  @unique
  address   String?
  phone     String?
  lineUrl   String?  /// LINE 官方帳號連結
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customers Customer[]
  staff     Staff[]
  bookings  Booking[]
}

/// 服務分類 (ServiceCategory)
model ServiceCategory {
  id          Int      @id @default(autoincrement())
  name        String   /// 例: 全身按摩, 腳底按摩
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  
  services    Service[]
}

/// 服務項目 (Service)
model Service {
  id              Int      @id @default(autoincrement())
  categoryId      Int
  name            String   /// 例: 全身經絡指壓
  durationMinutes Int      /// 服務時長 (分鐘)
  basePrice       Decimal  /// 基礎價格
  description     String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  category     ServiceCategory @relation(fields: [categoryId], references: [id])
  bookingItems BookingItem[]
}

/// 技師 (Staff)
model Staff {
  id        Int      @id @default(autoincrement())
  branchId  Int
  name      String
  code      String?  /// 技師編號 (例: 36, 88)
  level     String   /// Master | Senior | Junior
  photoUrl  String?
  bio       String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch        Branch             @relation(fields: [branchId], references: [id])
  availability  StaffAvailability[]
  bookings      Booking[]          /// 被指定的預約 (主技師)
  bookingItems  BookingItem[]      /// 實際執行的項目
}

/// 技師班表 / 可用時段 (StaffAvailability)
model StaffAvailability {
  id        Int      @id @default(autoincrement())
  staffId   Int
  date      DateTime
  startTime DateTime
  endTime   DateTime
  isBooked  Boolean  @default(false)
  
  staff     Staff @relation(fields: [staffId], references: [id])

  @@index([staffId, date])
}

/// 客戶 (Customer)
model Customer {
  id                Int      @id @default(autoincrement())
  phone             String   @unique /// 主要識別欄位
  name              String?
  email             String?
  lineId            String?
  preferredBranchId Int?
  notes             String?  /// 備註 (喜好、特殊需求等)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  branch    Branch?   @relation(fields: [preferredBranchId], references: [id])
  bookings  Booking[]
}

/// 預約主表 (Booking)
model Booking {
  id           Int      @id @default(autoincrement())
  branchId     Int
  customerId   Int
  staffId      Int?     /// 指定技師 (null = 不指定)
  
  bookingDate  DateTime /// 預約日期
  startTime    DateTime /// 預約開始時間
  endTime      DateTime /// 預計結束時間
  
  totalPrice     Decimal
  status         String   /// Pending | Confirmed | Completed | Cancelled | NoShow
  
  customerNotes  String?  /// 客戶留言
  internalNotes  String?  /// 內部備註
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  branch       Branch       @relation(fields: [branchId], references: [id])
  customer     Customer     @relation(fields: [customerId], references: [id])
  staff        Staff?       @relation(fields: [staffId], references: [id])
  items        BookingItem[]
}

/// 預約細項 (BookingItem) — 一張單可包含多個服務
model BookingItem {
  id        Int      @id @default(autoincrement())
  bookingId Int
  serviceId Int
  staffId   Int?     /// 該項目實際執行的技師 (可能不同項目不同人)
  price     Decimal  /// 實際成交價
  
  booking   Booking @relation(fields: [bookingId], references: [id])
  service   Service @relation(fields: [serviceId], references: [id])
  staff     Staff?  @relation(fields: [staffId], references: [id])
}
