# 502 Bad Gateway èˆ‡ ç«™é»å…§å®¹è¦†è“‹è¡çªä¿®å¾©ç´€éŒ„ (2026-02-21)

## ğŸ“Œ å•é¡Œä¸€ï¼š502 Bad Gateway (Prisma å¼•æ“å´©æ½°)

### ç¾è±¡
ç¶²ç«™ `book.gowork.run` ç„¡æ³•è¨ªå•ï¼ŒDocker å®¹å™¨æ—¥èªŒé¡¯ç¤º `stream did not contain valid UTF-8`ã€‚

### æ ¹å› 
- **CRLF æ›è¡Œå­—å…ƒè¡çª**ï¼šåœ¨ Windows é–‹ç™¼ç’°å¢ƒä¸‹ç”¢ç”Ÿçš„ `.prisma` æª”æ¡ˆå¸¶æœ‰ `\r\n`ã€‚ç•¶éƒ¨ç½²åˆ° Linux å®¹å™¨å¾Œï¼ŒPrisma å¼•æ“è§£æ `.prisma` æ ¼å¼æ™‚ç„¡æ³•è™•ç† `\r`ï¼Œå°è‡´å®¹å™¨å•Ÿå‹•å³å´©æ½° (Crash Loop)ã€‚

### ä¿®å¾©
- åœ¨ `Dockerfile` ä¸­åŠ å…¥ `sed` æŒ‡ä»¤ï¼Œå¼·åˆ¶åœ¨ Build-time å°‡ `prisma/` ç›®éŒ„ä¸‹çš„æ‰€æœ‰æª”æ¡ˆè½‰æ›ç‚º Linux æ ¼å¼ (`\n`)ã€‚
- æ›´æ–°éƒ¨æš‘è…³æœ¬ï¼Œåœ¨é ç«¯åŸ·è¡Œæ™‚è‡ªå‹•å°å…¨å°ˆæ¡ˆé€²è¡Œæ ¼å¼è½‰æ›ã€‚

---

## ğŸ“Œ å•é¡ŒäºŒï¼šç«™é»å…§å®¹äº’ç›¸è¦†è“‹ (Isolation Conflict)

### ç¾è±¡
éƒ¨ç½²æ–°ç«™é» `royal.gowork.run` (å¤§å…§å¾¡æŒ‡) å¾Œï¼ŒèˆŠç«™é» `book.gowork.run` çš„å…§å®¹è¢«è“‹æ‰ï¼Œæˆ–å…©ç«™é¡¯ç¤ºç›¸åŒçš„è³‡æ–™èˆ‡æ’ç‰ˆã€‚

### æ ¹å› 
é›–ç„¶å…©å€‹å°ˆæ¡ˆä½æ–¼ä¸åŒç›®éŒ„ (`/var/www/booking` èˆ‡ `/var/www/royal-booking`)ï¼Œä½†åœ¨ `docker-compose.prod.yml` ä¸­å®šç¾©äº†ç›¸åŒçš„**è™›æ“¬è­˜åˆ¥ç¬¦**ï¼š
1. **ç›¸åŒçš„ Docker Volume åç¨±**ï¼šéƒ½ä½¿ç”¨äº† `e111_data`ã€‚Docker æœƒæŠŠå…©å€‹ä¸åŒçš„è³‡æ–™åº«å®¹å™¨æ›è¼‰åˆ°åŒä¸€å€‹å¯¦é«”è·¯å¾‘ï¼Œå°è‡´è³‡æ–™äº’ç›¸è¦†è“‹ã€‚
2. **ç›¸åŒçš„ Docker Network åç¨±**ï¼šéƒ½ä½¿ç”¨äº† `e111-net`ã€‚
3. **Nginx é…ç½®æ®˜ç•™**ï¼š`/etc/nginx/sites-enabled/` ä¸­å­˜åœ¨é‡è¤‡çš„ `server_name` æŒ‡å‘èˆŠçš„ Port (3001)ï¼Œèˆ‡ `/etc/nginx/conf.d/` ä¸­çš„æ–°è¨­å®šç”¢ç”Ÿè¡çªã€‚

### ä¿®å¾©æ–¹æ¡ˆ (å¾¹åº•éš”é›¢)
ç‚ºäº†ç¢ºä¿å¤šç«™é»ä¸¦å­˜ï¼Œæˆ‘å€‘å¯¦æ–½äº†ã€Œå…¨éš”é›¢ã€éƒ¨ç½²æ–¹æ¡ˆï¼š

1. **è³‡æºåç¨±å”¯ä¸€åŒ–**ï¼š
   - **Booking ç«™é»**ï¼šä½¿ç”¨ Volume `e111_data` / Network `booking_e111-net` / Port `3001`ã€‚
   - **Royal ç«™é»**ï¼šä½¿ç”¨ Volume `royal_data` / Network `royal-net` / Port `3002`ã€‚
2. **Nginx é…ç½®æ¸…ç†**ï¼š
   - åˆªé™¤ `/etc/nginx/sites-enabled/` ä¸‹æ‰€æœ‰èˆ‡ `royal.gowork.run` ç›¸é—œçš„é€£çµã€‚
   - çµ±ä¸€ä½¿ç”¨ `/etc/nginx/conf.d/royal.gowork.run.conf`ï¼Œä¸¦ç²¾ç¢ºæŒ‡å‘ `localhost:3002`ã€‚
3. **éƒ¨ç½²è·¯å¾‘è¦ç¯„**ï¼š
   - èˆŠç«™é»ä¿ç•™åœ¨ `/var/www/booking`ã€‚
   - æ–°ç«™é»ç¨ç«‹å­˜æ”¾åœ¨ `/var/www/royal-booking/royal-booking`ã€‚

---

## ğŸ“Œ å•é¡Œä¸‰ï¼šæ–°ç«™é» 500 éŒ¯èª¤ (Missing Seed Data)

### ç¾è±¡
éš”é›¢éƒ¨ç½²å®Œæˆå¾Œï¼Œè¨ªå• `royal.gowork.run` å‡ºç¾ 500 éŒ¯èª¤ã€‚

### æ ¹å› 
- **è³‡æ–™åº«ç©ºç™½**ï¼šç”±æ–¼ä½¿ç”¨äº†æ–°çš„ Docker Volume (`royal_data`)ï¼Œè³‡æ–™åº«æ˜¯å…¨æ–°çš„ï¼Œå°šæœªåŸ·è¡Œ Seed æŒ‡ä»¤ï¼Œå°è‡´æ‡‰ç”¨ç¨‹å¼æŸ¥è©¢ä¸åˆ°åˆ†é¤¨èˆ‡æœå‹™è³‡è¨Šè€Œå ±éŒ¯ã€‚

### ä¿®å¾©
- æ‰‹å‹•é€²å…¥å®¹å™¨åŸ·è¡Œ `npx prisma db seed`ï¼Œç¢ºä¿åŸºç¤è³‡æ–™ï¼ˆåˆ†é¤¨ã€æœå‹™è¡¨ã€æŠ€å¸«ï¼‰å®Œæ•´å¯«å…¥æ–°è³‡æ–™åº«ã€‚

---

## ğŸ“Œ å•é¡Œå››ï¼šERR_TOO_MANY_REDIRECTS é‡æ–°å°å‘è¿´åœˆ (2026-02-23)

### ç¾è±¡
è¨ªå• `book.gowork.run` æ™‚ï¼Œç€è¦½å™¨é¡¯ç¤º `ERR_TOO_MANY_REDIRECTS`ï¼ˆé‡æ–°å°å‘æ¬¡æ•¸éå¤šï¼‰ã€‚

### æ ¹å› 
VPS å¾ Nginx é·ç§»è‡³ **Caddy + Cloudflare** æ¶æ§‹å¾Œï¼Œç”¢ç”Ÿäº†é‡æ–°å°å‘è¿´åœˆï¼š
1. Cloudflare DNS è¨­å®šç‚º **Proxy æ¨¡å¼**ï¼ˆæ©˜è‰²é›²æœµï¼‰ï¼Œæ‰€æœ‰ HTTPS è«‹æ±‚æœƒç¶“ç”± Cloudflare ä»¥ HTTP è½‰ç™¼è‡³ VPSã€‚
2. åŸæœ¬ `docker-compose.prod.yml` ä¸­ä»ä½¿ç”¨èˆŠçš„ `ports: "3001:3000"` å’Œ Nginx ç›´é€£æ–¹å¼ï¼Œç¼ºå°‘ Caddy labels åŠ `web-proxy` ç¶²è·¯ã€‚
3. Gateway ç«¯ Caddy å·²é…ç½® `book.gowork.run:80` ä»£ç†è‡³ `booking-app-1:3000`ï¼Œä½† booking å®¹å™¨æœªåŠ å…¥ `web-proxy` ç¶²è·¯ï¼ŒCaddy ç„¡æ³• resolve å®¹å™¨åç¨±ã€‚

### ä¿®å¾©
- æ›´æ–° `e111-booking/docker-compose.prod.yml`ï¼š
  - å®¹å™¨åç¨±çµ±ä¸€ç‚º `book-gowork-app` / `book-gowork-db`
  - åŠ å…¥ Caddy labelsï¼š`caddy: http://book.gowork.run` + `caddy.reverse_proxy`
  - åŠ å…¥ `web-proxy` external networkï¼Œè®“ Caddy èƒ½æ­£ç¢ºä»£ç†
  - Volume / Network åç¨±åŠ ä¸Š `book-gowork` å‰ç¶´é¿å…è¡çª
  - ä¿ç•™ `ports: "9088:3000"` ä½œç‚ºå‚™ç”¨ç›´é€£

---

## ğŸ› ï¸ ç¶­è­·æŒ‡å—ï¼šå¦‚ä½•å®‰å…¨éƒ¨ç½²æ–°ç«™é»ï¼Ÿ

1. **Caddy ä»£ç†**ï¼šæ–°ç«™é»å¿…é ˆåœ¨ `docker-compose.prod.yml` ä¸­åŠ å…¥ Caddy labels ä¸¦åŠ å…¥ `web-proxy` ç¶²è·¯ï¼Œä¸å†æ‰‹å‹•è¨­å®š Nginxã€‚
2. **Cloudflare é…åˆ**ï¼šè‹¥ä½¿ç”¨ Cloudflare Proxy æ¨¡å¼ï¼ŒCaddy label æ‡‰ä½¿ç”¨ `http://domain`ï¼ˆæ˜ç¢º HTTP schemeï¼‰ï¼Œé¿å…èˆ‡ Cloudflare çš„ HTTPS å¼·åˆ¶å°å‘å½¢æˆè¿´åœˆã€‚
3. **Compose éš”é›¢**ï¼šæ¯å€‹æ–°å°ˆæ¡ˆçš„ `docker-compose.prod.yml` å¿…é ˆæ”¹åå…¶ `volumes` èˆ‡ `networks`ï¼ˆä¾‹å¦‚åŠ å‰ç¶´ï¼‰ï¼Œé¿å… Docker èª¤èªã€‚
4. **æ ¼å¼æ¸…ç†**ï¼šè‹¥å¾ Windows ä¸Šå‚³ï¼Œè«‹å‹™å¿…åŸ·è¡Œ `sed -i 's/\r$//'` è™•ç† `.env` èˆ‡ `.prisma` æª”æ¡ˆã€‚

ç›®å‰ç‹€æ…‹ï¼š**å…©ç«™å·²å®Œå…¨åˆ†é›¢ï¼Œé‹ä½œç©©å®šã€‚å·²é·ç§»è‡³ Caddy Gateway æ¶æ§‹ã€‚**
- `book.gowork.run` -> Caddy ä»£ç† (åœ‹é†«ç‰ˆ)
- `royal.gowork.run` -> Caddy ä»£ç† (å¤§å…§å¾¡æŒ‡)
